# @restroom-mw/core

This package is where the main magic happens.

Listen to endpoints and look for the contracts in the right place.

It manages also the [lifecycle hooks](/architecture?id=lifecycle-hooks) system.

## Usage

Import

```js
const core = require("@restroom-mw/core");
```

and plug

```js
var app = express();
app.use("/api/*", core);
```

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

#### Table of Contents

*   [addDataToContext](#adddatatocontext)
    *   [Parameters](#parameters)
*   [Restroom](#restroom)
    *   [Parameters](#parameters-1)
    *   [onInit](#oninit)
        *   [Parameters](#parameters-2)
    *   [onBefore](#onbefore)
        *   [Parameters](#parameters-3)
    *   [onSuccess](#onsuccess)
        *   [Parameters](#parameters-4)
    *   [onAfter](#onafter)
        *   [Parameters](#parameters-5)
    *   [onError](#onerror)
        *   [Parameters](#parameters-6)
    *   [onException](#onexception)
        *   [Parameters](#parameters-7)
    *   [onFinish](#onfinish)
        *   [Parameters](#parameters-8)
    *   [safeJSONParse](#safejsonparse)
        *   [Parameters](#parameters-9)
        *   [Examples](#examples)
    *   [combineDataKeys](#combinedatakeys)
        *   [Parameters](#parameters-10)
        *   [Examples](#examples-1)
*   [addKeysToContext](#addkeystocontext)
    *   [Parameters](#parameters-11)
*   [addConfToContext](#addconftocontext)
    *   [Parameters](#parameters-12)
*   [getContractByContractName](#getcontractbycontractname)
    *   [Parameters](#parameters-13)
*   [sendError](#senderror)
    *   [Parameters](#parameters-14)
*   [getContractFromPath](#getcontractfrompath)
    *   [Parameters](#parameters-15)
*   [addNextToContext](#addnexttocontext)
    *   [Parameters](#parameters-16)
*   [getYml](#getyml)
    *   [Parameters](#parameters-17)
*   [addZenFileToContext](#addzenfiletocontext)
    *   [Parameters](#parameters-18)
*   [buildEndpointResponse](#buildendpointresponse)
    *   [Parameters](#parameters-19)
*   [executeChain](#executechain)
    *   [Parameters](#parameters-20)

### addDataToContext

[packages/core/src/context.ts:8-14](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/context.ts#L8-L14 "Source code on GitHub")

This function is responsible to add data into single block context

#### Parameters

*   `singleBlockContext` **any** 
*   `data` **any** 
*   `object` **singleBlockContext** context of a single block
*   `object` **data** data for the contract

### Restroom

[packages/core/src/restroom.ts:15-132](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/restroom.ts#L15-L132 "Source code on GitHub")

#### Parameters

*   `req` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** express req object
*   `res` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** express res object

**Meta**

*   **copyright**: 2020 Dyne.org
*   **author**: Puria Nafisi Azizi \<puria@dyne.org> @pna
*   **license**: AGPL-3.0-only

    Main class that will allow to define promise hooks and
    save \`data\` between different middlewares

#### onInit

[packages/core/src/restroom.ts:34-36](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/restroom.ts#L34-L36 "Source code on GitHub")

*   **See**: [lifecycle](/architecture?id=lifecycle-hooks)

Saves the promise to be executed at the onInit lifecycle step

##### Parameters

*   `promise` **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)** 

#### onBefore

[packages/core/src/restroom.ts:43-45](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/restroom.ts#L43-L45 "Source code on GitHub")

*   **See**: [lifecycle](/architecture?id=lifecycle-hooks)

Saves the promise to be executed at the onBefore lifecycle step

##### Parameters

*   `promise` **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)** 

#### onSuccess

[packages/core/src/restroom.ts:52-54](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/restroom.ts#L52-L54 "Source code on GitHub")

*   **See**: [lifecycle](/architecture?id=lifecycle-hooks)

Saves the promise to be executed at the onSuccess lifecycle step

##### Parameters

*   `promise` **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)** 

#### onAfter

[packages/core/src/restroom.ts:61-63](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/restroom.ts#L61-L63 "Source code on GitHub")

*   **See**: [lifecycle](/architecture?id=lifecycle-hooks)

Saves the promise to be executed at the onAfter lifecycle step

##### Parameters

*   `promise` **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)** 

#### onError

[packages/core/src/restroom.ts:70-72](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/restroom.ts#L70-L72 "Source code on GitHub")

*   **See**: [lifecycle](/architecture?id=lifecycle-hooks)

Saves the promise to be executed at the onError lifecycle step

##### Parameters

*   `promise` **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)** 

#### onException

[packages/core/src/restroom.ts:79-81](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/restroom.ts#L79-L81 "Source code on GitHub")

*   **See**: [lifecycle](/architecture?id=lifecycle-hooks)

Saves the promise to be executed at the onException lifecycle step

##### Parameters

*   `promise` **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)** 

#### onFinish

[packages/core/src/restroom.ts:88-90](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/restroom.ts#L88-L90 "Source code on GitHub")

*   **See**: [lifecycle](/architecture?id=lifecycle-hooks)

Saves the promise to be executed at the onFinish lifecycle step

##### Parameters

*   `promise` **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)** 

#### safeJSONParse

[packages/core/src/restroom.ts:104-112](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/restroom.ts#L104-L112 "Source code on GitHub")

Parse the potential JSON in a safe manner and return it as an object

##### Parameters

*   `o` **DK** 
*   `errorMessage` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)?** 
*   `keys` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 

##### Examples

````javascript
```
const keys = req.body.keys;
const data = await restroom.(keys);
```
````

*   Throws **[Error](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Error)** 

Returns **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 

#### combineDataKeys

[packages/core/src/restroom.ts:127-131](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/restroom.ts#L127-L131 "Source code on GitHub")

*   **See**: [combineDataKeys](/architecture?id=combine-data-keys)

Combine data and keys parsed as safe JSON objects into a single object

##### Parameters

*   `data` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
*   `keys` **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 

##### Examples

````javascript
```
const data = req.body.data;
const keys = req.body.keys;
const dataKeys = await restroom.combineDataKeys(data, keys);
```
````

Returns **[object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 

### addKeysToContext

[packages/core/src/context.ts:21-31](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/context.ts#L21-L31 "Source code on GitHub")

This function is responsible to add keys into single block context from selected .keys file

#### Parameters

*   `singleBlockContext` **any** 
*   `ymlContent` **any** 
*   `object` **singleBlockContext** context of a single block
*   `string` **blockName** block name

### addConfToContext

[packages/core/src/context.ts:38-41](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/context.ts#L38-L41 "Source code on GitHub")

This function is responsible to add keys into single block context from selected .keys file

#### Parameters

*   `singleBlockContext` **any** 
*   `ymlContent` **any** 
*   `object` **singleBlockContext** context of a single block
*   `string` **blockName** block name

### getContractByContractName

[packages/core/src/utils.ts:38-40](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/utils.ts#L38-L40 "Source code on GitHub")

Returns zencode from a contract name

#### Parameters

*   `contractName` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 

Returns **Zencode** 

### sendError

[packages/core/src/index.ts:46-63](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/index.ts#L46-L63 "Source code on GitHub")

Centralized api error handling

#### Parameters

*   `subject` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
*   `e` **NodeJS.ErrnoException**  (optional, default `null`)
*   `string` **subject** subject

### getContractFromPath

[packages/core/src/utils.ts:47-49](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/utils.ts#L47-L49 "Source code on GitHub")

Returns zencode from a partial path

#### Parameters

*   `path` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 

Returns **Zencode** 

### addNextToContext

[packages/core/src/context.ts:48-50](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/context.ts#L48-L50 "Source code on GitHub")

This function is responsible to add next into single block context from yaml flow

#### Parameters

*   `singleBlockContext` **any** 
*   `ymlContent` **any** 
*   `object` **singleBlockContext** context of a single block
*   `object` **ymlContent** yaml content

### getYml

[packages/core/src/utils.ts:56-58](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/utils.ts#L56-L58 "Source code on GitHub")

Returns string representing a .yml file

#### Parameters

*   `ymlName` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 

Returns **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 

### addZenFileToContext

[packages/core/src/context.ts:57-59](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/context.ts#L57-L59 "Source code on GitHub")

This function is responsible to add zenFile into single block context from yaml flow

#### Parameters

*   `singleBlockContext` **any** 
*   `ymlContent` **any** 
*   `object` **singleBlockContext** context of a single block
*   `object` **ymlContent** yaml content

### buildEndpointResponse

[packages/core/src/index.ts:70-79](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/index.ts#L70-L79 "Source code on GitHub")

Centralized api response handling

#### Parameters

*   `restroomResult` **RestroomResult** 
*   `res` **[Response](https://developer.mozilla.org/docs/Web/Guide/HTML/HTML5)** 
*   `RestroomResult` **restroomResult** containing restroom result
*   `Response` **res** endpoint response

### executeChain

[packages/core/src/index.ts:94-115](https://github.com/dyne/restroom-mw/blob/089cc4dcc808a9010a9655cf585ce8da80dd394f/packages/core/src/index.ts#L94-L115 "Source code on GitHub")

Function responsible to execute the chain

#### Parameters

*   `fileContents` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 
*   `data` **any** 
*   `string` **ymlFile** containing restroom result
*   `object` **data** data object coming from endpoint

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)\<RestroomResult>** 
